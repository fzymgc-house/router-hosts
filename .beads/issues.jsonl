{"id":"router-hosts-8w6","title":"OTEL metrics export not working - metrics crate not bridged to OpenTelemetry","description":"When export_metrics = true is set in [metrics.otel] config, metrics are not exported to OTEL collector. The metrics crate facade is used for recording but there's no bridge to OpenTelemetry - only tracing-opentelemetry for traces exists. Workaround: use Prometheus scraping instead.\n\nGitHub Issue: #237","status":"open","priority":2,"issue_type":"bug","owner":"4678+seanb4t@users.noreply.github.com","created_at":"2026-01-19T16:53:10.501323-05:00","created_by":"seanb4t","updated_at":"2026-01-19T16:53:10.501323-05:00","comments":[{"id":1,"issue_id":"router-hosts-8w6","author":"seanb4t","text":"## Root Cause Analysis Complete\n\n### Problem\nTwo disconnected metrics systems exist:\n1. metrics crate -\u003e PrometheusBuilder::install_recorder() in prometheus.rs:27-29 -\u003e Prometheus endpoint (works)\n2. SdkMeterProvider created in otel.rs:103 but NEVER receives any metrics (dead end)\n\n### Evidence\n- counter!(), histogram!(), gauge!() macros in counters.rs go to the Prometheus recorder\n- SdkMeterProvider is stored in MetricsHandle but no code connects it to the metrics crate\n- The OTEL initialization logs success but no metrics flow through\n\n### Solution\nAdd metrics-exporter-opentelemetry v0.2.1 as a bridge:\n- Compatible with current metrics ^0.24 and opentelemetry ^0.31\n- Replaces PrometheusBuilder::install_recorder() with OTEL-backed recorder when export_metrics = true\n\n### Files to Modify\n- Cargo.toml (workspace)\n- crates/router-hosts/Cargo.toml\n- crates/router-hosts/src/server/metrics/mod.rs\n- crates/router-hosts/src/server/metrics/otel.rs","created_at":"2026-01-19T21:55:35Z"},{"id":2,"issue_id":"router-hosts-8w6","author":"seanb4t","text":"## Implementation Complete\n\n### Changes Made\n1. Added `metrics-exporter-opentelemetry = \"0.2\"` to workspace dependencies\n2. Updated `otel.rs` to use `metrics-exporter-opentelemetry::Recorder` which bridges `metrics` crate → OpenTelemetry\n3. Updated `mod.rs` to:\n   - Initialize OTEL metrics FIRST (installs global recorder)\n   - Skip Prometheus endpoint when OTEL metrics is enabled (only one global recorder allowed)\n\n### Architecture After Fix\n```\ncounter!() / histogram!() / gauge!()\n    ↓\nmetrics-exporter-opentelemetry::Recorder\n    ↓\nSdkMeterProvider with OTLP PeriodicReader\n    ↓\nOTEL Collector (via gRPC on port 4317)\n```\n\n### Test Results\n- Build: SUCCESS\n- Tests: 790 passed, 0 failed\n- Lint: PASSED","created_at":"2026-01-19T22:01:37Z"}]}
