syntax = "proto3";

package router_hosts.v1;

import "google/protobuf/timestamp.proto";

// Host entry messages

// Represents a single host entry in the hosts file
message HostEntry {
  // Unique identifier for this host entry (ULID format)
  string id = 1;

  // IP address (IPv4 or IPv6) for the host
  string ip_address = 2;

  // DNS hostname or FQDN for the host
  string hostname = 3;

  // Optional comment to appear in hosts file
  optional string comment = 4;

  // Optional tags for categorization and filtering (e.g., "homelab", "production")
  repeated string tags = 5;

  // Timestamp when this entry was created
  google.protobuf.Timestamp created_at = 6;

  // Timestamp when this entry was last updated
  google.protobuf.Timestamp updated_at = 7;

  // Version identifier for optimistic concurrency control.
  // Treat as opaque - compare for equality only, do not parse.
  // Format may change in future versions.
  string version = 8;
}

// Host management requests/responses

// Request to add a new host entry
message AddHostRequest {
  // IP address (IPv4 or IPv6) for the new host (required)
  string ip_address = 1;

  // DNS hostname for the new host (required)
  string hostname = 2;

  // Optional comment for the host entry
  optional string comment = 3;

  // Optional tags for categorization
  repeated string tags = 4;
}

// Response after adding a host entry
message AddHostResponse {
  // ID of the newly created host entry
  string id = 1;

  // The complete host entry that was created
  HostEntry entry = 2;
}

// Request to retrieve a single host entry by ID
message GetHostRequest {
  // ID of the host entry to retrieve
  string id = 1;
}

// Response containing the requested host entry
message GetHostResponse {
  // The requested host entry
  HostEntry entry = 1;
}

// Request to update an existing host entry
message UpdateHostRequest {
  // ID of the host entry to update (required)
  string id = 1;

  // New IP address (optional, keeps existing if not provided)
  optional string ip_address = 2;

  // New hostname (optional, keeps existing if not provided)
  optional string hostname = 3;

  // New comment (optional, keeps existing if not provided, empty string to clear)
  optional string comment = 4;

  // New tags array (replaces all existing tags). Empty array = clear all tags.
  // Not providing this field = keep existing tags unchanged.
  repeated string tags = 5;

  // Expected version for optimistic concurrency control.
  // If provided and doesn't match current version, returns ABORTED.
  // Treat as opaque - use the value from GetHost response unchanged.
  // Example: Get host, receive version "1", update with expected_version "1".
  // Note: Empty string is invalid and will return INVALID_ARGUMENT.
  optional string expected_version = 6;
}

// Response after updating a host entry
message UpdateHostResponse {
  // The updated host entry with new values
  HostEntry entry = 1;
}

// Request to delete a host entry (creates tombstone event)
message DeleteHostRequest {
  // ID of the host entry to delete
  string id = 1;
}

// Response after deleting a host entry
message DeleteHostResponse {
  // Whether the deletion succeeded
  bool success = 1;
}

// Request to list host entries with optional filtering and pagination
message ListHostsRequest {
  // Optional filter expression (e.g., by tag, active status)
  optional string filter = 1;

  // Maximum number of entries to return (pagination)
  optional int32 limit = 2;

  // Number of entries to skip (pagination)
  optional int32 offset = 3;
}

// Response containing a single host entry (streamed)
message ListHostsResponse {
  // A host entry from the list
  HostEntry entry = 1;
}

// Request to search for host entries by query
message SearchHostsRequest {
  // Search query (searches IP, hostname, comment, and tags)
  string query = 1;
}

// Response containing a single matching host entry (streamed)
message SearchHostsResponse {
  // A host entry that matches the search query
  HostEntry entry = 1;
}

// Import/Export operations

// Request to import hosts from a file format via streaming chunks
message ImportHostsRequest {
  // Chunk of file data being uploaded
  bytes chunk = 1;

  // Whether this is the final chunk of the import
  bool last_chunk = 2;

  // Import format: "hosts" (default), "json", "csv"
  optional string format = 3;

  // Conflict handling: "skip" (default), "replace", "strict"
  optional string conflict_mode = 4;
}

// Response for host import operation (streamed progress updates)
//
// Example counter values for importing 5 entries where 2 already exist:
//
// With conflict_mode = "skip":
//   processed=5, created=3, updated=0, skipped=2, failed=0
//   (existing entries left unchanged, counted as skipped)
//
// With conflict_mode = "replace":
//   processed=5, created=3, updated=2, skipped=0, failed=0
//   (existing entries updated with new values)
//
// Example with validation failures (2 invalid entries):
//   processed=5, created=2, updated=0, skipped=0, failed=3
//   validation_errors=["Line 1: Invalid IP '999.0.0.1': ...",
//                      "Line 3: Invalid hostname 'bad_host': ...",
//                      "Line 5: Invalid IP 'not-an-ip': ..."]
//
// Note: In replace mode, if existing entry has identical values, it counts
// as skipped (no-op), not updated.
message ImportHostsResponse {
  // Total entries processed so far
  int32 processed = 1;

  // Successfully created entries
  int32 created = 2;

  // Existing entries updated. Only non-zero when conflict_mode = "replace".
  // In skip mode, duplicates increment skipped instead.
  int32 updated = 3;

  // Duplicates skipped (when conflict_mode = "skip")
  int32 skipped = 4;

  // Validation failures
  int32 failed = 5;

  // Error message if import operation encountered an issue
  optional string error = 6;

  // Details of validation failures (line number and reason)
  // Only populated when failed > 0
  repeated string validation_errors = 7;
}

// Request to export all hosts in a specified format
message ExportHostsRequest {
  // Export format: "hosts" (standard /etc/hosts), "json", or "csv"
  string format = 1;
}

// Response containing exported host data (streamed in chunks)
message ExportHostsResponse {
  // Chunk of exported data in the requested format
  bytes chunk = 1;
}

// Snapshot requests/responses

// Request to create a snapshot of the current hosts database state
message CreateSnapshotRequest {}

// Response after creating a snapshot
message CreateSnapshotResponse {
  // Unique identifier for the newly created snapshot
  string snapshot_id = 1;
}

// Represents a saved snapshot of the hosts database at a point in time
message Snapshot {
  // Unique identifier for this snapshot
  string snapshot_id = 1;

  // Timestamp when this snapshot was created
  google.protobuf.Timestamp created_at = 2;

  // Number of host entries captured in this snapshot
  int32 entry_count = 3;

  // What triggered this snapshot (e.g., "manual", "pre-rollback", "scheduled")
  string trigger = 4;
}

// Request to list all available snapshots
message ListSnapshotsRequest {}

// Response containing a single snapshot (streamed)
message ListSnapshotsResponse {
  // A snapshot from the list
  Snapshot snapshot = 1;
}

// Request to restore the hosts database to a previous snapshot state
message RollbackToSnapshotRequest {
  // ID of the snapshot to restore
  string snapshot_id = 1;
}

// Response after rolling back to a snapshot
message RollbackToSnapshotResponse {
  // Whether the rollback succeeded
  bool success = 1;

  // ID of the auto-created snapshot taken before rollback (for undo capability)
  string new_snapshot_id = 2;
}

// Request to delete a snapshot
message DeleteSnapshotRequest {
  // ID of the snapshot to delete
  string snapshot_id = 1;
}

// Response after deleting a snapshot
message DeleteSnapshotResponse {
  // Whether the deletion succeeded
  bool success = 1;
}

// Service definition for managing /etc/hosts entries via gRPC
service HostsService {
  // Host management

  // Add a new host entry to the hosts file
  rpc AddHost(AddHostRequest) returns (AddHostResponse);

  // Retrieve a single host entry by its ID
  rpc GetHost(GetHostRequest) returns (GetHostResponse);

  // Update an existing host entry
  rpc UpdateHost(UpdateHostRequest) returns (UpdateHostResponse);

  // Delete a host entry (creates tombstone event)
  rpc DeleteHost(DeleteHostRequest) returns (DeleteHostResponse);

  // List all host entries with optional filtering and pagination (server streaming)
  rpc ListHosts(ListHostsRequest) returns (stream ListHostsResponse);

  // Search for host entries by query string (server streaming)
  rpc SearchHosts(SearchHostsRequest) returns (stream SearchHostsResponse);

  // Import/Export operations

  // Import hosts from a file format via client streaming with server progress updates
  rpc ImportHosts(stream ImportHostsRequest) returns (stream ImportHostsResponse);

  // Export all hosts in a specified format via server streaming
  rpc ExportHosts(ExportHostsRequest) returns (stream ExportHostsResponse);

  // Snapshots

  // Create a snapshot of the current hosts database state
  rpc CreateSnapshot(CreateSnapshotRequest) returns (CreateSnapshotResponse);

  // List all available snapshots (server streaming)
  rpc ListSnapshots(ListSnapshotsRequest) returns (stream ListSnapshotsResponse);

  // Restore the hosts database to a previous snapshot (creates backup snapshot first)
  rpc RollbackToSnapshot(RollbackToSnapshotRequest) returns (RollbackToSnapshotResponse);

  // Delete a snapshot by its ID
  rpc DeleteSnapshot(DeleteSnapshotRequest) returns (DeleteSnapshotResponse);
}
