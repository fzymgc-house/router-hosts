syntax = "proto3";

package router_hosts.v1;

import "google/protobuf/timestamp.proto";

// Host entry messages

// Represents a single host entry in the /etc/hosts file
message HostEntry {
  // Unique identifier for this host entry (UUID format)
  string id = 1;

  // IP address (IPv4 or IPv6) for the host
  string ip_address = 2;

  // DNS hostname or FQDN for the host
  string hostname = 3;

  // Optional comment to appear in /etc/hosts (supports inline comments)
  optional string comment = 4;

  // Optional tags for categorization and filtering (e.g., "homelab", "production")
  repeated string tags = 5;

  // Timestamp when this entry was created
  google.protobuf.Timestamp created_at = 6;

  // Timestamp when this entry was last updated
  google.protobuf.Timestamp updated_at = 7;

  // Whether this entry is active (false = soft deleted, won't appear in /etc/hosts)
  bool active = 8;
}

// Host management requests/responses

// Request to add a new host entry
message AddHostRequest {
  // Optional edit session token. If provided, changes are staged; if omitted, entry is added immediately
  optional string edit_token = 1;

  // IP address (IPv4 or IPv6) for the new host (required)
  string ip_address = 2;

  // DNS hostname for the new host (required)
  string hostname = 3;

  // Optional comment for the host entry
  optional string comment = 4;

  // Optional tags for categorization
  repeated string tags = 5;
}

// Response after adding a host entry
message AddHostResponse {
  // ID of the newly created host entry
  string id = 1;

  // The complete host entry that was created
  HostEntry entry = 2;
}

message GetHostRequest {
  string id = 1;
}

message GetHostResponse {
  HostEntry entry = 1;
}

// Request to update an existing host entry
message UpdateHostRequest {
  // Optional edit session token. If provided, changes are staged; if omitted, changes apply immediately
  optional string edit_token = 1;

  // ID of the host entry to update (required)
  string id = 2;

  // New IP address (optional, keeps existing if not provided)
  optional string ip_address = 3;

  // New hostname (optional, keeps existing if not provided)
  optional string hostname = 4;

  // New comment (optional, keeps existing if not provided, empty string to clear)
  optional string comment = 5;

  // New tags array (replaces all existing tags). Empty array = clear all tags.
  // Not providing this field = keep existing tags unchanged.
  repeated string tags = 6;
}

message UpdateHostResponse {
  HostEntry entry = 1;
}

message DeleteHostRequest {
  optional string edit_token = 1;
  string id = 2;
}

message DeleteHostResponse {
  bool success = 1;
}

message ListHostsRequest {
  optional string filter = 1;
  optional int32 limit = 2;
  optional int32 offset = 3;
}

message ListHostsResponse {
  HostEntry entry = 1;
}

message SearchHostsRequest {
  string query = 1;
}

message SearchHostsResponse {
  HostEntry entry = 1;
}

// Edit session requests/responses
// Only ONE edit session can be active at a time server-wide

// Request to start a new edit session
message StartEditRequest {}

// Response containing the edit session token
message StartEditResponse {
  // Edit token to use with subsequent operations. Valid for 15 minutes (timeout resets on each operation)
  string edit_token = 1;
}

// Request to commit all changes from an edit session
message FinishEditRequest {
  // Edit token from StartEditResponse
  string edit_token = 1;
}

// Response after committing edit session changes
message FinishEditResponse {
  // Whether the commit succeeded
  bool success = 1;

  // Number of host entries that were changed during this edit session
  int32 entries_changed = 2;
}

// Request to cancel an edit session and discard all changes
message CancelEditRequest {
  // Edit token from StartEditResponse
  string edit_token = 1;
}

// Response after canceling edit session
message CancelEditResponse {
  // Whether the cancellation succeeded
  bool success = 1;
}

// Bulk operations
message BulkAddHostsRequest {
  optional string edit_token = 1;
  string ip_address = 2;
  string hostname = 3;
  optional string comment = 4;
  repeated string tags = 5;
}

message BulkAddHostsResponse {
  optional string id = 1;
  optional string error = 2;
}

message ImportHostsRequest {
  optional string edit_token = 1;
  bytes chunk = 2;
  bool last_chunk = 3;
}

message ImportHostsResponse {
  int32 imported = 1;
  int32 failed = 2;
  optional string error = 3;
}

message ExportHostsRequest {
  string format = 1; // "hosts", "json", "csv"
}

message ExportHostsResponse {
  bytes chunk = 1;
}

// Snapshot requests/responses
message CreateSnapshotRequest {
  optional string name = 1;
}

message CreateSnapshotResponse {
  string snapshot_id = 1;
}

message Snapshot {
  string snapshot_id = 1;
  google.protobuf.Timestamp created_at = 2;
  int32 entry_count = 3;
  string trigger = 4;
  optional string name = 5;
}

message ListSnapshotsRequest {}

message ListSnapshotsResponse {
  Snapshot snapshot = 1;
}

message RollbackToSnapshotRequest {
  string snapshot_id = 1;
}

message RollbackToSnapshotResponse {
  bool success = 1;
  string new_snapshot_id = 2;
}

message DeleteSnapshotRequest {
  string snapshot_id = 1;
}

message DeleteSnapshotResponse {
  bool success = 1;
}

// Service definition
service HostsService {
  // Host management
  rpc AddHost(AddHostRequest) returns (AddHostResponse);
  rpc GetHost(GetHostRequest) returns (GetHostResponse);
  rpc UpdateHost(UpdateHostRequest) returns (UpdateHostResponse);
  rpc DeleteHost(DeleteHostRequest) returns (DeleteHostResponse);
  rpc ListHosts(ListHostsRequest) returns (stream ListHostsResponse);
  rpc SearchHosts(SearchHostsRequest) returns (stream SearchHostsResponse);

  // Edit sessions
  rpc StartEdit(StartEditRequest) returns (StartEditResponse);
  rpc FinishEdit(FinishEditRequest) returns (FinishEditResponse);
  rpc CancelEdit(CancelEditRequest) returns (CancelEditResponse);

  // Bulk operations
  rpc BulkAddHosts(stream BulkAddHostsRequest) returns (stream BulkAddHostsResponse);
  rpc ImportHosts(stream ImportHostsRequest) returns (stream ImportHostsResponse);
  rpc ExportHosts(ExportHostsRequest) returns (stream ExportHostsResponse);

  // Snapshots
  rpc CreateSnapshot(CreateSnapshotRequest) returns (CreateSnapshotResponse);
  rpc ListSnapshots(ListSnapshotsRequest) returns (stream ListSnapshotsResponse);
  rpc RollbackToSnapshot(RollbackToSnapshotRequest) returns (RollbackToSnapshotResponse);
  rpc DeleteSnapshot(DeleteSnapshotRequest) returns (DeleteSnapshotResponse);
}
