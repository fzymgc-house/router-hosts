# CLAUDE.md

Instructions for Claude Code when working in this repository.

## Terminology

The key words "MUST", "MUST NOT", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.

## Required Skills

You MUST use these skills at the specified trigger points:

| Trigger | Skill | Rationale |
|---------|-------|-----------|
| Before any feature/creative work | `superpowers:brainstorming` | Explore requirements before implementation |
| When encountering bugs or failures | `superpowers:systematic-debugging` | Structured root cause analysis |
| Before claiming work is complete | `superpowers:verification-before-completion` | Verify with evidence, not assumptions |
| When asked to review code/PR | `pr-review-toolkit:review-pr` | Comprehensive multi-agent review |
| After creating or updating a PR | `pr-review-toolkit:review-pr` | Catch issues before human review |

You SHOULD use these skills when applicable:

| Trigger | Skill | Rationale |
|---------|-------|-----------|
| Starting isolated feature work | `superpowers:using-git-worktrees` | Avoid polluting main workspace |
| Planning multi-step implementation | `superpowers:writing-plans` | Create structured implementation plans |
| Creating commits | `commit-commands:commit` | Consistent conventional commits |

## Development Workflow

### Trunk-Based Development

- You MUST create feature branches from `main` for all changes
- You MUST use branch naming: `feat/`, `fix/`, `refactor/`, `docs/`
- You SHOULD keep PRs under 400 lines changed
- You MUST NOT push directly to `main`

### Commit Messages

You MUST follow Conventional Commits format:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:** `feat`, `fix`, `refactor`, `perf`, `test`, `docs`, `build`, `ci`, `chore`

**Scopes:** `proto`, `server`, `client`, `storage`, `validation`, `config`, `ci`, `deps`, `helm`, `docs`, `operator`

Scopes are recommended for clarity but not enforced. See `cog.toml` for scope descriptions.

**Rules:**
- Subject line MUST be ≤50 characters, imperative mood, no period
- Body SHOULD wrap at 72 characters
- Footer MUST reference issues: `Fixes #123`, `Closes #456`

### Pull Requests

- PRs MUST pass all CI checks before merge
- You MUST NOT use `gh pr edit --add-reviewer` for human reviewers
- You MUST use `pr-review-toolkit:review-pr` for code review

### CI Workflows

- You MUST NOT modify `.github/workflows/v-release.yml` directly in any way
  - This file is auto-generated by cargo-dist and validated at runtime
  - Any modifications (including comments) will cause release builds to fail
  - To update: modify `dist-workspace.toml` and run `dist generate-ci`
- You MAY modify other workflow files (release-please.yml, docs.yml, etc.)

## Build and Test Commands

You MUST use `task` commands instead of direct `cargo` invocations.

You SHOULD run `task --list` to see all available commands and their purposes.

| Command | Purpose |
|---------|---------|
| `task build` | Build all crates (debug) |
| `task test` | Run unit + integration tests |
| `task test:coverage` | Generate coverage report |
| `task test:coverage:ci` | Coverage with 80% threshold |
| `task lint` | Run all linters |
| `task fmt` | Format all code |
| `task e2e` | End-to-end tests |
| `task ci` | Full CI pipeline locally |

You MUST NOT run `cargo test` or `cargo tarpaulin` directly.

You MUST maintain ≥80% test coverage. PRs that decrease coverage below 80% MUST be rejected.

## Code Quality

### Error Handling

- You MUST use `Result<T, E>` for fallible operations
- You MUST NOT use `.unwrap()` or `.expect()` in library code
- You SHOULD use `thiserror` for custom error types
- You MUST propagate errors with `?` operator

### Testing

- You MUST add tests for all new code
- You MUST add a regression test for every bug fix
- You SHOULD use `proptest` for validation logic
- You MUST NOT write to real filesystem in tests (use tempfiles or mocks)

### Linting

- You MUST run `cargo clippy -- -D warnings` before committing
- You MUST NOT add `#[allow(...)]` or suppression directives without explicit justification AND user approval
- You SHOULD fix lint warnings properly, not suppress them

## Development Setup

### Prerequisites

- **Rust toolchain** (stable): `rustup install stable`
- **buf CLI** (protobuf): `brew install bufbuild/buf/buf`
- **cocogitto** (commit validation): `brew install cocogitto`
- **pre-commit**: `pip install pre-commit && pre-commit install`

### Issue Tracking

All tasks are tracked in GitHub Issues. You MUST:
- Reference issues in commits: `Fixes #123`, `Closes #456`
- Create new issues for discovered work or follow-up tasks

## Project Context

**router-hosts** is a Rust CLI for managing DNS host entries via client-server architecture with gRPC over mTLS.

### Crate Structure

| Crate | Purpose |
|-------|---------|
| `router-hosts-common` | Protobuf definitions, validation, shared types |
| `router-hosts-storage` | Storage trait with SQLite (default), PostgreSQL, DuckDB backends |
| `router-hosts` | Main binary (SQLite + PostgreSQL only) |
| `router-hosts-duckdb` | DuckDB variant binary (all three backends) |
| `router-hosts-e2e` | Docker-based E2E tests with real mTLS |

**Storage defaults:** SQLite is the default backend. When no database URL is configured, an XDG-compliant path is used (`~/.local/share/router-hosts/hosts.db` on Linux).

For detailed architecture, see `docs/contributing/architecture.md`.

## Documentation

For detailed information, see:

| Topic | Location |
|-------|----------|
| Architecture & design decisions | `docs/contributing/architecture.md` |
| ACME certificate management | `docs/guides/acme.md` |
| Operations (SIGHUP, hooks) | `docs/guides/operations.md` |
| Release process | `docs/contributing/releasing.md` |
| E2E testing details | `docs/contributing/testing.md` |
| Troubleshooting | `docs/troubleshooting.md` |
| Design specification | `docs/plans/2025-12-01-router-hosts-v1-design.md` |
