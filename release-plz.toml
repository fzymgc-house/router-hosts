# release-plz configuration
# Documentation: https://release-plz.dev/docs/config
#
# This configuration manages automated release PRs and changelog generation
# while letting cargo-dist handle the actual binary builds and GitHub Releases.

[workspace]
# Generate changelog entries from conventional commits
changelog_update = true

# Use cargo-semver-checks to detect breaking changes
semver_check = true

# Don't publish to crates.io - binaries only
publish = false

# Git tag format (matches cargo-dist expectations)
git_tag_name = "v{{ version }}"

# Let cargo-dist create GitHub Releases (triggered by tag push)
git_release_enable = false

# PR configuration
pr_name = "chore: release v{{ version }}"
pr_body = """
## Release v{{ version }}

This PR was automatically created by [release-plz](https://release-plz.dev).

### Changes
{{ changelog }}

### Checklist
- [ ] Review changelog entries
- [ ] Verify version bump is correct (major/minor/patch)
- [ ] Merge when ready to release

After merge, the version tag will trigger:
- `v-release.yml` - Builds binaries, creates GitHub Release
- `helm-release.yml` - Publishes Helm chart to ghcr.io
- `docs.yml` - Deploys documentation to Cloudflare Pages
"""

[changelog]
# Keep a Changelog format (matches existing CHANGELOG.md style)
body = """
## [{{ version }}] - {{ date }}
{% for group, commits in commits | group_by(attribute="group") %}

### {{ group | upper_first }}
{% for commit in commits %}
- {{ commit.message | upper_first }}\
{% if commit.scope %} ({{ commit.scope }}){% endif %}\
{% if commit.breaking %} **BREAKING**{% endif %}
{% endfor %}
{% endfor %}
"""

# Map conventional commit types to changelog sections
commit_parsers = [
    { message = "^feat", group = "Added" },
    { message = "^fix", group = "Fixed" },
    { message = "^perf", group = "Performance" },
    { message = "^refactor", group = "Changed" },
    { message = "^docs", group = "Documentation" },
    { message = "^test", group = "Testing" },
    { message = "^build", group = "Build" },
    { message = "^ci", group = "CI/CD" },
    { message = "^chore", skip = true },
]

# router-hosts is the "main" package that drives versioning
# Other workspace crates inherit version from workspace
[[package]]
name = "router-hosts"

# Sync version to Helm chart (Chart.yaml version and appVersion)
version_files = [
    { path = "charts/router-hosts-operator/Chart.yaml", pattern = 'version: {{ version }}' },
    { path = "charts/router-hosts-operator/Chart.yaml", pattern = 'appVersion: {{ version }}' },
]
