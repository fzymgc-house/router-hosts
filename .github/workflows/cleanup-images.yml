name: Cleanup Docker Images

on:
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering for testing

# ============================================================================
# ACTION SELECTION RATIONALE
# ============================================================================
# This workflow uses snok/container-retention-policy instead of the official
# actions/delete-package-versions action for the following reasons:
#
# 1. UNSUPPORTED PARAMETERS IN OFFICIAL ACTION:
#    - actions/delete-package-versions@v5 does NOT support:
#      - `older-than`: Time-based retention (we need 7 days)
#      - `version-pattern`: Regex filtering (we need to target SHA tags)
#      - `dry-run`: Safe testing mode
#    - These parameters are silently ignored, making the workflow ineffective
#
# 2. ALTERNATIVE ACTION EVALUATION:
#    - snok/container-retention-policy@v3.0.1:
#      ✓ Supports time-based retention via `cut-off`
#      ✓ Supports dry-run mode
#      ✓ Active maintenance (235 stars, commits within last month)
#      ✓ Issues get resolved promptly
#      ✓ Clean, focused feature set
#
#    - dataaxiom/ghcr-cleanup-action (REJECTED):
#      ✗ Critical bugs in core features (issues #99, #101)
#      ✗ No maintainer response for 2+ months
#      ✗ Last release 11 months ago
#      ✗ Shows signs of abandonment
#
# 3. TRADE-OFFS AND WORKAROUNDS:
#    - snok does NOT support regex pattern matching for tag selection
#    - Workaround: Use `image-tags` to explicitly protect production tags
#    - Unprotected tags (SHA-based dev images) are cleaned by `cut-off`
#    - See docs/workarounds/ghcr-cleanup.md for detailed explanation
#
# ============================================================================
# ACTION VERSION MANAGEMENT
# ============================================================================
# This workflow uses snok/container-retention-policy@v3.0.1 (pinned).
# Renovate automatically updates pinned GitHub Actions (see .github/renovate.json).
#
# Migration path: If actions/delete-package-versions adds support for
# older-than, version-pattern, and dry-run, evaluate switching back.
# ============================================================================
# PRE-RELEASE TAG PROTECTION
# ============================================================================
# The protected tag list below covers:
# - 'latest' tag
# - Basic semver tags (v1.0.0, v0.5.0)
# - Pre-release tags (v1.0.0-beta.1, v1.0.0-rc.2)
#
# NOTE: Build metadata tags (v1.0.0+build.123) are NOT protected.
# If you use build metadata in production, add them to `image-tags`.
# ============================================================================

jobs:
  cleanup:
    runs-on: ubuntu-latest

    permissions:
      packages: write  # Required to delete package versions
      contents: read   # Standard read access

    steps:
      - name: Clean up old container images
        uses: snok/container-retention-policy@v3.0.1
        with:
          account: fzymgc-house
          token: ${{ secrets.GITHUB_TOKEN }}

          # Target the router-hosts package
          image-names: router-hosts

          # Delete images older than 7 days (equivalent to older-than: 7)
          cut-off: 1w

          # Keep at least 3 most recent images (equivalent to min-versions-to-keep: 3)
          keep-n-most-recent: 3

          # Target both tagged and untagged images
          # Tagged: SHA-based images (e.g., abc123def456) will be cleaned
          # Untagged: Intermediate layers and orphaned manifests will be cleaned
          tag-selection: both

          # Protect production tags using ! prefix, target all others with *
          # The ! prefix means "don't delete these tags"
          # The * means "target all other tags for deletion"
          # See: https://github.com/snok/container-retention-policy#image-tags
          image-tags: "!latest !v*.*.* *"

          # Dry-run disabled after successful validation (see #88)
          dry-run: false
