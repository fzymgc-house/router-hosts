# CI Workflow - Parallelized build, test, and E2E pipeline
#
# Job Dependencies:
#   lint ──────┬──> test-coverage
#              │
#   helm-lint  │   (parallel)
#              │
#   build ─────┴──> e2e
#              │
#              └──> ci-complete (requires all)
#
# Critical path: lint -> build -> e2e (~8.5 min)
# Cache strategy: Save cache from same-repo PRs (not forks, for security)

name: CI

on:
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────────
  # Job 1: Lint - Fast feedback on code quality
  # ─────────────────────────────────────────────────────────────
  lint:
    runs-on:
      - runs-on=${{ github.run_id }}/runner=2cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache/spot=lowest-price
    timeout-minutes: 10

    steps:
      - uses: runs-on/action@v2
        with:
          metrics: cpu,network,memory,disk,io

      - uses: actions/checkout@v6

      - name: Setup Rust environment
        uses: ./.github/actions/rust-setup

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Run linters
        run: task lint

  # ─────────────────────────────────────────────────────────────
  # Job 2: Helm Lint - Validate Helm chart (fast, parallel with lint)
  # ─────────────────────────────────────────────────────────────
  helm-lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.0.4

      - name: Lint Helm chart
        run: helm lint charts/router-hosts-operator

  # ─────────────────────────────────────────────────────────────
  # Job 3: Build - Create release binary for E2E tests
  # ─────────────────────────────────────────────────────────────
  build:
    runs-on:
      - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=150gb:600mbs:4000iops
    timeout-minutes: 30

    steps:
      - uses: runs-on/action@v2
        with:
          metrics: cpu,network,memory,disk,io

      - uses: actions/checkout@v6

      - name: Setup Rust environment
        uses: ./.github/actions/rust-setup
        with:
          save-cache: ${{ github.event.pull_request.head.repo.full_name == github.repository }}

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Build release binary
        run: task build:release

      - name: Upload release binary
        uses: actions/upload-artifact@v6
        with:
          name: release-binary
          path: target/release/router-hosts
          retention-days: 1

  # ─────────────────────────────────────────────────────────────
  # Job 4: Test with Coverage - Run all tests with coverage
  # Note: Runs all tests including PostgreSQL via --workspace flag
  # ─────────────────────────────────────────────────────────────
  test-coverage:
    needs: [lint] # Fast-fail on lint errors
    runs-on:
      - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=150gb:600mbs:4000iops
    timeout-minutes: 20

    steps:
      - uses: runs-on/action@v2
        with:
          metrics: cpu,network,memory,disk,io

      - uses: actions/checkout@v6

      - name: Setup Rust environment
        uses: ./.github/actions/rust-setup

      - name: Setup CI tools
        uses: ./.github/actions/ci-tools

      - name: Check test coverage (≥80% required)
        run: task test:coverage:ci

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # Job 5: E2E Tests - Requires release binary
  # ─────────────────────────────────────────────────────────────
  e2e:
    needs: [build]
    runs-on:
      - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=150gb:600mbs:4000iops
    timeout-minutes: 20

    steps:
      - uses: runs-on/action@v2
        with:
          metrics: cpu,network,memory,disk,io

      - uses: actions/checkout@v6

      - name: Setup Rust environment
        uses: ./.github/actions/rust-setup

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Download release binary
        uses: actions/download-artifact@v6
        with:
          name: release-binary
          path: target/release/

      - name: Make binary executable
        run: chmod +x target/release/router-hosts

      - name: Build CI Docker image
        run: task docker:build-ci IMAGE_NAME=router-hosts IMAGE_TAG=ci

      - name: Verify Docker image runs
        run: |
          set -euo pipefail
          echo "Testing binary inside container..."
          docker run --rm router-hosts:ci --help
          docker run --rm router-hosts:ci server --help
          echo "Binary runs successfully"

      - name: Run E2E tests
        run: task e2e:quick IMAGE_NAME=router-hosts IMAGE_TAG=ci

  # ─────────────────────────────────────────────────────────────
  # Job 6: CI Complete - Aggregation gate for branch protection
  # ─────────────────────────────────────────────────────────────
  ci-complete:
    if: always()
    needs: [lint, helm-lint, build, test-coverage, e2e]
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - name: Check all jobs passed
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          HELM_LINT_RESULT: ${{ needs.helm-lint.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          TEST_COVERAGE_RESULT: ${{ needs.test-coverage.result }}
          E2E_RESULT: ${{ needs.e2e.result }}
        run: |
          if [[ "$LINT_RESULT" != "success" ]] || \
             [[ "$HELM_LINT_RESULT" != "success" ]] || \
             [[ "$BUILD_RESULT" != "success" ]] || \
             [[ "$TEST_COVERAGE_RESULT" != "success" ]] || \
             [[ "$E2E_RESULT" != "success" ]]; then
            echo "One or more jobs failed:"
            echo "  lint: $LINT_RESULT"
            echo "  helm-lint: $HELM_LINT_RESULT"
            echo "  build: $BUILD_RESULT"
            echo "  test-coverage: $TEST_COVERAGE_RESULT"
            echo "  e2e: $E2E_RESULT"
            exit 1
          fi
          echo "All CI jobs passed successfully"
