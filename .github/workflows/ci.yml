name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        runs-on:
            - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=100gb

        steps:
            - uses: runs-on/action@v2
              with:
                  metrics: cpu,network,memory,disk,io

            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install protoc
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler
                  echo "PROTOC=$(which protoc)" >> "$GITHUB_ENV"
                  protoc --version
              env:
                  DEBIAN_FRONTEND: noninteractive

            - name: Install buf
              uses: bufbuild/buf-setup-action@v1
              with:
                  github_token: ${{ github.token }}

            - name: Install Task
              uses: arduino/setup-task@v2

            # Use Swatinem/rust-cache for better Rust caching
            # This caches ~/.cargo and target/ with smart invalidation
            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  # Cache the protobuf-src build which takes 10+ minutes
                  cache-all-crates: "true"
                  # Include Cargo.toml in cache key for better invalidation
                  key: ${{ runner.os }}-rust

            - name: Build
              run: task build

            - name: Run PostgreSQL backend tests
              run: task test:postgres

            - name: Build release binary
              run: task build:release

            - name: Build CI Docker image
              run: task docker:build-ci IMAGE_NAME=router-hosts IMAGE_TAG=ci

            - name: Verify Docker image runs
              run: |
                  echo "Testing binary inside container..."
                  docker run --rm router-hosts:ci --help
                  docker run --rm router-hosts:ci server --help
                  echo "Binary runs successfully"

            - name: Run E2E tests
              run: task e2e:quick IMAGE_NAME=router-hosts IMAGE_TAG=ci

            - name: Install cargo-tarpaulin
              uses: taiki-e/install-action@v2
              with:
                  tool: cargo-tarpaulin

            - name: Check test coverage (â‰¥80% required)
              # Coverage runs all tests with instrumentation enabled
              run: task test:coverage:ci

            - name: Upload coverage report
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 14
