name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build:
        runs-on:
            - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=100gb

        permissions:
            contents: read
            packages: write

        outputs:
            image-tag: ${{ steps.meta.outputs.tags }}

        steps:
            - uses: runs-on/action@v2
              with:
                  metrics: cpu,network,memory,disk,io

            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install buf
              uses: bufbuild/buf-setup-action@v1
              with:
                  github_token: ${{ github.token }}

            - name: Install Task
              uses: arduino/setup-task@v2

            # Use Swatinem/rust-cache for better Rust caching
            # This caches ~/.cargo and target/ with smart invalidation
            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  # Cache the protobuf-src build which takes 10+ minutes
                  cache-all-crates: "true"
                  # Include Cargo.toml in cache key for better invalidation
                  key: ${{ runner.os }}-rust

            - name: Build
              run: task build

            - name: Run tests
              run: task test:unit

            # Docker build and push
            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=sha,prefix=sha-

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}

            # TODO: Enable test coverage enforcement once implementation begins
            # CLAUDE.md mandates â‰¥80% coverage, but deferred for skeleton PR
            # Uncomment when ready:
            # - name: Check test coverage
            #   run: task test:coverage

    e2e-tests:
        needs: [build]
        runs-on:
            - runs-on=${{ github.run_id }}/runner=4cpu-linux-x64/image=ubuntu24-full-x64/extras=s3-cache+docker/spot=lowest-price/volume=100gb

        permissions:
            contents: read
            packages: read

        steps:
            - uses: runs-on/action@v2
              with:
                  metrics: cpu,network,memory,disk,io

            - uses: actions/checkout@v6

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install Task
              uses: arduino/setup-task@v2

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  cache-all-crates: "true"
                  # Use same key as build job to share the build cache
                  key: ${{ runner.os }}-rust

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Run E2E tests
              # Use short SHA to match docker/metadata-action format
              run: task e2e IMAGE_TAG=sha-${GITHUB_SHA::7}
