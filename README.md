# router-hosts

[![CI](https://github.com/fzymgc-house/router-hosts/actions/workflows/ci.yml/badge.svg)](https://github.com/fzymgc-house/router-hosts/actions/workflows/ci.yml)
[![Coverage](https://img.shields.io/badge/coverage-%E2%89%A580%25-green)](docs/test-coverage-audit.md)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

Rust CLI tool for managing DNS host entries on routers via gRPC.

## Overview

**router-hosts** provides a client-server architecture for remotely managing `/etc/hosts` files on routers (OpenWrt or similar embedded Linux):

- **Server** runs on the router, exposes gRPC API, manages host entries with event-sourced storage
- **Client** runs on your workstation, provides CLI for all operations
- **Kubernetes Operator** automates DNS registration for Traefik IngressRoutes and custom HostMappings
- Supports versioning, bulk operations, snapshots with rollback, and validation
- TLS with mutual authentication for security
- Prometheus metrics for observability

See [Architecture](docs/architecture.md) for detailed design.

## Project Structure

```
router-hosts/
â”œâ”€â”€ crates/
â”‚   â”œâ”€â”€ router-hosts-common/   # Shared validation, types, protobuf
â”‚   â”œâ”€â”€ router-hosts-storage/  # Storage backends (SQLite, PostgreSQL, DuckDB)
â”‚   â”œâ”€â”€ router-hosts/          # Main binary (client + server modes)
â”‚   â”œâ”€â”€ router-hosts-duckdb/   # DuckDB variant binary
â”‚   â”œâ”€â”€ router-hosts-operator/ # Kubernetes operator
â”‚   â””â”€â”€ router-hosts-e2e/      # End-to-end tests
â”œâ”€â”€ charts/
â”‚   â””â”€â”€ router-hosts-operator/ # Helm chart for operator
â””â”€â”€ proto/
    â””â”€â”€ router_hosts/
        â””â”€â”€ v1/
            â””â”€â”€ hosts.proto    # gRPC service definitions
```

## Development

### Prerequisites

- Rust 1.75+
- Docker
- [Task](https://taskfile.dev/) (recommended)
- [buf](https://buf.build/) (for protobuf)

### Quick Start

```bash
# Install Task (macOS)
brew install go-task

# Build
task build

# Run tests
task test

# Run E2E tests (requires Docker)
task e2e

# Full CI pipeline locally
task ci
```

### Available Tasks

| Task | Description |
|------|-------------|
| `task build` | Build all crates (debug) |
| `task build:release` | Build all crates (release) |
| `task test` | Run unit and integration tests |
| `task lint` | Run all linters |
| `task fmt` | Format all code |
| `task docker:build` | Build server Docker image |
| `task e2e` | Run E2E acceptance tests |
| `task ci` | Run full CI pipeline locally |

### Manual Commands

#### Build

```bash
cargo build
```

#### Test

```bash
cargo test
```

#### Run in Client Mode (default)

```bash
cargo run -- --help
cargo run -- add --ip 192.168.1.10 --hostname server.local
```

#### Run in Server Mode

```bash
cargo run -- server --config server.toml
```

### Docker

```bash
# Build server image
task docker:build

# Run specific E2E scenario
task e2e:scenario -- daily_operations
```

## Installation

### Shell Installer (macOS/Linux)

```bash
curl --proto '=https' --tlsv1.2 -LsSf \
  https://github.com/fzymgc-house/router-hosts/releases/latest/download/router-hosts-installer.sh | sh
```

### Homebrew (macOS/Linux)

```bash
# Download Homebrew formula from release
curl -LO https://github.com/fzymgc-house/router-hosts/releases/latest/download/router-hosts.rb

# Install from formula
brew install --formula ./router-hosts.rb
```

> **Note:** Shell installer and Homebrew install binaries to `~/.local/bin`. Ensure this directory is in your `PATH`:
> ```bash
> export PATH="$HOME/.local/bin:$PATH"
> ```
> Add this line to your shell profile (`~/.bashrc`, `~/.zshrc`, etc.) to make it permanent.

<details>
<summary>Troubleshooting Installation</summary>

If `router-hosts` command is not found after installation:

1. **Verify installation:** `ls -la ~/.local/bin/router-hosts`
2. **Check PATH:** `echo $PATH | grep -o ~/.local/bin`
3. **Restart shell** or run: `source ~/.bashrc` (or `~/.zshrc`)
4. **Manual PATH fix:** `export PATH="$HOME/.local/bin:$PATH"`

</details>

### Pre-built Binaries

Download from [GitHub Releases](https://github.com/fzymgc-house/router-hosts/releases/latest):
- macOS (Intel & Apple Silicon)
- Linux (x64 & ARM64)

### Verifying Binaries

All release binaries include [GitHub attestations](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations/using-artifact-attestations-to-establish-provenance-for-builds) and embedded dependency information (via [cargo-auditable](https://github.com/rust-secure-code/cargo-auditable)) for supply chain security:

```bash
# Verify cryptographic attestation (proves binary came from this repo)
gh attestation verify router-hosts --repo fzymgc-house/router-hosts

# Audit embedded dependency information for known vulnerabilities
cargo auditable audit router-hosts
```

> **Note:** GitHub attestations are automatically generated by [cargo-dist](https://github.com/axodotdev/cargo-dist) v0.30.3+ during the release workflow.

### Build from Source

```bash
git clone https://github.com/fzymgc-house/router-hosts.git
cd router-hosts
cargo build --release
```

### Distribution Methods

**router-hosts** uses two complementary distribution workflows:

**CLI Binaries (cargo-dist)**:
- Published to [GitHub Releases](https://github.com/fzymgc-house/router-hosts/releases) on version tags (e.g., `v0.5.0`)
- Multi-platform binaries: macOS (Intel/ARM), Linux (x64/ARM64)
- Includes shell installer and Homebrew formula
- Use for: Installing CLI on workstations for remote management

**Server Containers (Docker)**:
- Published to [GitHub Container Registry](https://github.com/fzymgc-house/router-hosts/pkgs/container/router-hosts) on every main branch commit
- Multi-arch images: `linux/amd64`, `linux/arm64`
- Tagged with commit SHA and `latest`
- Use for: Deploying server on routers, servers, or containers

```bash
# Pull latest server image
docker pull ghcr.io/fzymgc-house/router-hosts:latest

# Run server container
docker run -v /path/to/config:/config ghcr.io/fzymgc-house/router-hosts:latest server --config /config/server.toml
```

## Status

âœ… **v0.6.0 Released** - Core features complete with Kubernetes operator

**Features:**
- âœ… Client CLI with all commands (host, snapshot, config)
- âœ… Server with event sourcing and multiple storage backends
- âœ… SQLite (default), PostgreSQL, and DuckDB storage options
- âœ… Import/Export (hosts, JSON, CSV formats)
- âœ… Snapshots with rollback and retention
- âœ… mTLS authentication with SIGHUP certificate reload
- âœ… ACME certificate automation (HTTP-01 and DNS-01)
- âœ… Kubernetes operator for Traefik integration
- âœ… Prometheus metrics instrumentation
- âœ… Full E2E test coverage (10 scenarios)

**v0.7.0 In Progress:**
- âœ… Leader election for operator HA
- âœ… Health RPC for operator readiness
- ðŸ”² Documentation updates

See [Releases](https://github.com/fzymgc-house/router-hosts/releases) for version history.

## License

MIT
