# Pre-commit hooks for router-hosts
# Install: pre-commit install && pre-commit install --hook-type pre-push && pre-commit install --hook-type commit-msg
# Run manually: pre-commit run --all-files
# Run all stages: pre-commit run --all-files --hook-stage pre-push
#
# Hooks are ordered by speed (fast checks first) for fail-fast behavior.
# Expensive checks (clippy) run only on pre-push stage.
# Tests run in ci.yml workflow, not pre-commit (avoids CI duplication).

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # Fast file checks (run on every commit)
      - id: check-merge-conflict
      - id: check-yaml
        exclude: '^(charts/.*/templates/.*\.yaml|mkdocs\.yml)$'  # Exclude Helm templates and MkDocs (Python tags)
      - id: check-toml
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-added-large-files
        args: ['--maxkb=500']

  - repo: local
    hooks:
      # Fast formatting checks (run on every commit)
      - id: cargo-fmt
        name: cargo fmt
        entry: cargo fmt -- --check
        language: system
        types: [rust]
        pass_filenames: false

      - id: buf-format
        name: buf format
        entry: buf format --diff --exit-code
        language: system
        files: '\.proto$'
        pass_filenames: false

      - id: buf-lint
        name: buf lint
        entry: buf lint
        language: system
        files: '\.proto$'
        pass_filenames: false

      - id: shellcheck
        name: shellcheck
        entry: shellcheck
        language: system
        types: [shell]
        # Run on all shell scripts in examples/
        files: 'examples/.*\.sh$'

      # Conventional commit message validation (commit-msg stage)
      # Requires: cargo install cocogitto
      - id: conventional-commit
        name: conventional commit
        entry: cog verify --file
        language: system
        stages: [commit-msg]
        always_run: true

      # Expensive checks (run only on pre-push)
      # Note: Runs on entire workspace regardless of changed files
      # because Rust changes can affect other crates via dependencies
      - id: cargo-clippy
        name: cargo clippy
        entry: cargo clippy --workspace -- -D warnings
        language: system
        types: [rust]
        pass_filenames: false
        stages: [pre-push]
